name: Deploy to Azure

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Override Supabase client for self-hosted
        run: |
          cat > src/integrations/supabase/client.ts << 'OVERRIDE'
          import { createClient } from '@supabase/supabase-js';
          import type { Database } from './types';
          const SUPABASE_URL = "https://api.atad2.tax";
          const SUPABASE_PUBLISHABLE_KEY = "eyJhbGciOiAiSFMyNTYiLCAidHlwIjogIkpXVCJ9.eyJyb2xlIjogImFub24iLCAiaXNzIjogInN1cGFiYXNlIiwgImlhdCI6IDE2NDE3NjkyMDAsICJleHAiOiAxNzk5NTM1NjAwfQ.rnsxsFRAvsoKzOta2QUNb7D_nzd4erNRN4WyqBw99UY";
          export const supabase = createClient<Database>(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY, {
            auth: { storage: localStorage, persistSession: true, autoRefreshToken: true }
          });
          OVERRIDE

      - name: Override n8n webhook URLs
        run: |
          sed -i 's|https://lennartwilming.app.n8n.cloud/webhook/|https://n8n.atad2.tax/webhook/|g' src/pages/AssessmentReport.tsx
          sed -i 's|https://lennartwilming.app.n8n.cloud/webhook/|https://n8n.atad2.tax/webhook/|g' src/components/MemoFeedbackEditor.tsx
          sed -i 's|https://lennartwilming.app.n8n.cloud/webhook/|https://n8n.atad2.tax/webhook/|g' src/components/FeedbackWidget.tsx

      - run: npm install

      - run: npm run build
        env:
          VITE_SUPABASE_URL: https://api.atad2.tax
          VITE_SUPABASE_ANON_KEY: eyJhbGciOiAiSFMyNTYiLCAidHlwIjogIkpXVCJ9.eyJyb2xlIjogImFub24iLCAiaXNzIjogInN1cGFiYXNlIiwgImlhdCI6IDE2NDE3NjkyMDAsICJleHAiOiAxNzk5NTM1NjAwfQ.rnsxsFRAvsoKzOta2QUNb7D_nzd4erNRN4WyqBw99UY

      - name: Create deployment zip
        run: cd dist && zip -r ../deploy.zip .

      - name: Deploy to Azure (clean)
        env:
          PUBLISH_PROFILE: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        run: |
          USERNAME=$(echo "$PUBLISH_PROFILE" | grep -oP 'userName="\K[^"]+' | head -1)
          PASSWORD=$(echo "$PUBLISH_PROFILE" | grep -oP 'userPWD="\K[^"]+' | head -1)
          curl -X POST "https://app-atad2-prod.scm.azurewebsites.net/api/publish?type=zip&clean=true" \
            -u "$USERNAME:$PASSWORD" \
            -H "Content-Type: application/zip" \
            --data-binary @deploy.zip \
            --fail --show-error --silent -w "\nHTTP Status: %{http_code}\n"
